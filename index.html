<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VNB Karte</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body style="margin:0">
<div id="map" style="height:100vh;"></div>

<script>
const map = L.map('map').setView([51.1657, 10.4515], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let mapping = {};

Papa.parse('mapping.csv', {
  download: true,
  header: true,
  delimiter: ";",
  complete: function(results) {
    results.data.forEach(row => {
      mapping[row.PLZ] = parseFloat(row.WERT);
    });
    loadGeoJSON();
  }
});

function getColor(value) {
  return value > 0.8 ? '#006837' :
         value > 0.6 ? '#31a354' :
         value > 0.4 ? '#78c679' :
         value > 0.2 ? '#c2e699' :
                       '#ffffcc';
}

function loadGeoJSON() {
  fetch('plz5.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: function(feature) {
          const plz = feature.properties.plz;
          const wert = mapping[plz];
          return {
            color: 'black',
            weight: 0.3,
            fillOpacity: 0.7,
            fillColor: getColor(wert || 0)
          };
        },
        onEachFeature: function(feature, layer) {
          const plz = feature.properties.plz;
          const wert = mapping[plz];
          layer.bindPopup(`PLZ: ${plz}<br>WERT: ${wert !== undefined ? wert : 'n/a'}`);
        }
      }).addTo(map);
    });
}
</script>
</body>
</html>
