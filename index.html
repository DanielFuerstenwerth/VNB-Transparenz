<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VNB-Transparenz</title>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map {height:100%;margin:0}
    .legend{position:absolute;bottom:10px;left:10px;z-index:800;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,.2);max-height:40vh;overflow:auto;
      font:12px system-ui,Arial}
    .legend .row{display:flex;gap:8px;align-items:center;margin:4px 0}
    .legend .sw{width:14px;height:14px;border-radius:3px;border:1px solid #0002}
    .bar{position:absolute;top:10px;left:10px;z-index:800;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,.2);
      display:flex;gap:8px;align-items:center;font:13px system-ui,Arial}
    .bar input{padding:6px 8px;border:1px solid #ccc;border-radius:6px;width:200px}
    .pill{padding:4px 8px;border:1px solid #ccc;border-radius:999px;cursor:pointer;user-select:none}
    .pill.active{background:#eee}
  </style>
</head>
<body>
<div id="map"></div>
<div class="bar">
  <input id="q" placeholder="PLZ oder VNB…" />
  <div id="tgl" class="pill">Grenzen an/aus</div>
</div>
<div id="leg" class="legend"><b>VNB</b><div id="rows"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CSV_URL = 'mapping.csv';
const GEO_URL = 'data/plz_simplified.geojson';

// robuste fetch-funktion
async function fetchStrict(url, type){
  const r = await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error(url+' → HTTP '+r.status);
  const ct=(r.headers.get('content-type')||'').toLowerCase();
  if(type==='json' && !ct.includes('json')){
    const head=(await r.clone().text()).slice(0,120).replace(/\s+/g,' ');
    throw new Error(url+' liefert '+ct+'; start: '+head);
  }
  return type==='json'? r.json(): r.text();
}

// hilfsfunktionen
function parseCSV(txt, sep=';'){
  return txt.trim().split(/\r?\n/).filter(l=>l.trim()).map(l=>l.split(sep).map(s=>s.trim()));
}
function colorFor(s){
  let h=0; for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))>>>0;
  return `hsl(${h%360} 60% 60%)`;
}
function getPLZ(f){
  return String(
    f.properties?.PLZ ?? f.properties?.plz ?? f.properties?.plz_code ??
    f.properties?.postcode ?? f.properties?.post_code ?? f.properties?.zip ?? ''
  );
}

// leaflet map init
const map = L.map('map').setView([51.16,10.45],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:12,
  attribution:'© OpenStreetMap, Daten: Opendatasoft/OSM, BKG'
}).addTo(map);

let bordersOn=true, geoLayer, mapping=new Map(), vnbSet=new Set(), plzIndex=new Map();

// lade daten
Promise.all([
  fetchStrict(CSV_URL,'text'),
  fetchStrict(GEO_URL,'json')
]).then(([csvText,geo])=>{
  if(geo.type!=='FeatureCollection'||!geo.features?.length) throw new Error('GeoJSON leer/ungültig');

  // csv verarbeiten
  const rows=parseCSV(csvText,';');
  let start=0;
  if(rows.length && rows[0].some(x=>isNaN(Number(x))&&/plz|vnb|wert/i.test(x))) start=1;
  for(let i=start;i<rows.length;i++){
    const [plz,vnb,wertRaw]=rows[i];
    if(!plz) continue;
    const wert=Number((wertRaw||'').toString().replace(',','.'));
    mapping.set(plz,{vnb:vnb||'unbekannt',wert:isNaN(wert)?null:wert});
    if(vnb) vnbSet.add(vnb);
  }

  // legende
  const rowsDiv=document.getElementById('rows');
  [...vnbSet].sort((a,b)=>a.localeCompare(b,'de')).slice(0,80).forEach(v=>{
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`<span class="sw" style="background:${colorFor(v)}"></span><span>${v}</span>`;
    d.onclick=()=>zoomToVNB(v);
    rowsDiv.appendChild(d);
  });

  // styling
  const style=f=>{
    const plz=getPLZ(f);
    const entry=mapping.get(plz);
    const vnb=entry?entry.vnb:'ohne Zuordnung';
    return {
      color:bordersOn?'#333':'transparent',
      weight:bordersOn?0.6:0,
      opacity:bordersOn?0.7:0,
      fillColor:colorFor(vnb),
      fillOpacity:0.6
    };
  };

  // interaktion
  const onEach=(f,l)=>{
    const plz=getPLZ(f);
    plzIndex.set(plz,l);
    const entry=mapping.get(plz);
    const vnb=entry?entry.vnb:'ohne Zuordnung';
    const wert=entry?entry.wert:null;
    l.bindTooltip(`PLZ ${plz}<br>VNB: ${vnb}${wert!=null?`<br>Wert: ${wert}`:''}`,{sticky:true});
    l.on({mouseover:e=>e.target.setStyle({weight:2,opacity:1}),
          mouseout:e=>geoLayer.resetStyle(e.target),
          click:e=>map.fitBounds(e.target.getBounds(),{maxZoom:9})});
  };

  // zeichnen
  geoLayer=L.geoJSON(geo,{style,onEachFeature:onEach}).addTo(map);
  map.fitBounds(geoLayer.getBounds());

  // ui handler
  document.getElementById('tgl').onclick=()=>{bordersOn=!bordersOn;geoLayer.setStyle(style);};
  document.getElementById('q').addEventListener('keydown',e=>{
    if(e.key!=='Enter') return;
    const q=e.target.value.trim().toLowerCase(); if(!q) return;
    if(plzIndex.has(q)){const ly=plzIndex.get(q);map.fitBounds(ly.getBounds(),{maxZoom:9});ly.fire('mouseover');return;}
    let found=null;
    geoLayer.eachLayer(ly=>{
      const plz=getPLZ(ly.feature);
      const v=(mapping.get(plz)||{}).vnb||'';
      if(!found && v.toLowerCase().includes(q)) found=ly;
    });
    if(found){map.fitBounds(found.getBounds(),{maxZoom:8});found.fire('mouseover');}
  });

  function zoomToVNB(vnbName){
    const bds=[];
    geoLayer.eachLayer(ly=>{
      const plz=getPLZ(ly.feature);
      const entry=mapping.get(plz);
      if(entry && entry.vnb===vnbName) bds.push(ly.getBounds());
    });
    if(bds.length){
      const all=bds.reduce((acc,b)=>acc?acc.extend(b):L.latLngBounds(b),null);
      map.fitBounds(all,{padding:[20,20]});
    }
  }
}).catch(e=>{alert('Fehler: '+e.message);console.error(e);});
</script>
</body>
</html>
