<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Karte – Geometrien</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
// ---- Konfiguration: beide Pfade, wir nehmen den ersten der funktioniert
const CANDIDATES = ['data/geo_plz_min.topo.json','data/geo.topo.min.json'];

// EPSG:3857 (WebMercator Meter) -> WGS84 (lon/lat Grad)
function wmToLonLat(x, y){
  const lon = x / 20037508.34 * 180;
  let lat  = y / 20037508.34 * 180;
  lat = 180/Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI/180)) - Math.PI/2);
  return [lon, lat];
}
function reprojectGeometry(g){
  // rekursiv über Koordinaten
  function walk(c){
    if (typeof c[0] === 'number') return wmToLonLat(c[0], c[1]);
    return c.map(walk);
  }
  g.coordinates = walk(g.coordinates);
  return g;
}
function isMeterCoords(geojson){
  // prüfe ein paar punkte: sind |lon| oder |lat| >> 180 -> vermutlich Meter
  const f = geojson.features?.[0];
  if(!f) return false;
  let c = f.geometry?.coordinates;
  while (Array.isArray(c) && typeof c[0] !== 'number') c = c[0];
  if (!Array.isArray(c) || typeof c[0] !== 'number') return false;
  const [x,y] = c;
  return Math.abs(x) > 180 || Math.abs(y) > 90;
}

async function loadFirstWorking(urls){
  for(const u of urls){
    const r = await fetch(u, {cache:'no-store'});
    if(r.ok) return r.json();
  }
  throw new Error('keine TopoJSON-Datei gefunden');
}

(async()=>{
  if(typeof topojson==='undefined'){console.error('topojson-client fehlt');return;}

  // 1) Topo laden (erst reduziertes, dann originales)
  const topo = await loadFirstWorking(CANDIDATES);

  // 2) GeoJSON erzeugen (erstes Objekt mit Geometrien)
  const objs = topo.objects || {};
  const key = Object.keys(objs).find(k => Array.isArray(objs[k]?.geometries) && objs[k].geometries.length)
           || Object.keys(objs)[0];
  if(!key){ console.error('TopoJSON ohne geometries'); return; }
  const geo = topojson.feature(topo, objs[key]);

  // 3) Reprojektion falls nötig
  if (isMeterCoords(geo)) {
    geo.features.forEach(f => { f.geometry = reprojectGeometry(f.geometry); });
  }

  // 4) Leaflet
  const map = L.map('map', {minZoom:5, maxZoom:12}).setView([51.2,10.4],6);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'© OSM'}).addTo(map);

  const layer = L.geoJSON(geo, { style:{ color:'#333', weight:.4, fillOpacity:.6, fillColor:'#cfe9ff' } }).addTo(map);
  if (layer.getLayers().length) map.fitBounds(layer.getBounds(), {padding:[20,20]});
})();
</script>
</body>
</html>
