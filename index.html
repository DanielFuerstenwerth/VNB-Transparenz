<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Karte – reprojiziert</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
const URL_TOPO = 'data/geo.topo.min.json';

// EPSG:3857 → lon/lat
function wmToLonLat(x, y){
  const lon = x / 20037508.34 * 180;
  let lat  = y / 20037508.34 * 180;
  lat = 180/Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI/180)) - Math.PI/2);
  return [lon, lat];
}

// rekursiv alle Koordinaten durchlaufen
function reprojectCoords(coords){
  if(typeof coords[0]==='number'){ return wmToLonLat(coords[0], coords[1]); }
  return coords.map(reprojectCoords);
}

(async()=>{
  const r = await fetch(URL_TOPO,{cache:'no-store'});
  if(!r.ok){console.error('TopoJSON HTTP',r.status);return;}
  const topo = await r.json();

  const key = Object.keys(topo.objects||{})[0];
  const geo = topojson.feature(topo, topo.objects[key]);

  // prüfen, ob Meter-Koordinaten
  let sample = geo.features[0].geometry.coordinates;
  while(Array.isArray(sample[0])) sample = sample[0];
  if(Math.abs(sample[0])>180 || Math.abs(sample[1])>90){
    geo.features.forEach(f=>{ f.geometry.coordinates = reprojectCoords(f.geometry.coordinates); });
  }

  const map = L.map('map',{minZoom:5,maxZoom:12}).setView([51.2,10.4],6);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);

  const layer = L.geoJSON(geo,{
    style:{color:'#333',weight:.4,fillOpacity:.6,fillColor:'#cfe9ff'}
  }).addTo(map);

  map.fitBounds(layer.getBounds(),{padding:[20,20]});
})();
</script>
</body>
</html>
